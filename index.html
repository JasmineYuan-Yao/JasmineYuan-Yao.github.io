<!doctype html>
<html lang="zh-CN" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŸå¸‚ç©ºæ°”æ±¡æŸ“å¾„å‘çƒ­åŠ›å›¾</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans SC', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    /* Radial chart styles */
    .radial-segment {
      transition: opacity 0.2s ease, transform 0.15s ease;
      cursor: pointer;
    }
    .radial-segment:hover {
      opacity: 1 !important;
      filter: brightness(1.2);
    }
    
    /* Pollutant buttons */
    .pollutant-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .pollutant-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .pollutant-btn:hover::before { opacity: 1; }
    .pollutant-btn.active {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(var(--glow-color), 0.5);
    }
    
    /* Tooltip */
    .tooltip {
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      backdrop-filter: blur(12px);
    }
    
    /* Year slider */
    .year-range-track {
      background: linear-gradient(90deg, #334155 0%, #475569 50%, #334155 100%);
    }
    
    /* Narrative mode */
    .narrative-overlay {
      backdrop-filter: blur(8px);
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    .narrative-highlight {
      animation: pulse 2s ease-in-out infinite;
    }
    
    /* Legend gradient */
    .legend-gradient {
      background: linear-gradient(90deg, 
        #22c55e 0%, 
        #84cc16 20%, 
        #eab308 40%, 
        #f97316 60%, 
        #ef4444 80%, 
        #7c2d12 100%
      );
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    /* Month labels animation */
    .month-label {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    /* Stats cards */
    .stat-card {
      background: linear-gradient(135deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,0.9) 100%);
      border: 1px solid rgba(71,85,105,0.5);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      border-color: rgba(99,102,241,0.5);
      transform: translateY(-2px);
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full overflow-auto">
  <div id="app" class="min-h-full w-full p-4 md:p-6 lg:p-8"><!-- Header -->
   <header class="max-w-7xl mx-auto mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
     <div>
      <h1 id="main-title" class="text-2xl md:text-3xl lg:text-4xl font-bold text-white tracking-tight">åŸå¸‚ç©ºæ°”è´¨é‡å¹´è½®å›¾</h1>
      <p class="text-slate-400 mt-1 text-sm md:text-base"><span id="city-display">åŒ—äº¬</span> Â· 2015-2026 Â· æ¯æ—¥æ±¡æŸ“ç‰©æµ“åº¦å¯è§†åŒ–</p>
     </div><button id="narrative-btn" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition-all flex items-center gap-2 self-start md:self-auto">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg> å¼€å¯å™äº‹æ¨¡å¼ </button>
    </div>
   </header><!-- Main Content -->
   <main class="max-w-7xl mx-auto"><!-- Controls Panel -->
    <div class="bg-slate-800/50 rounded-2xl p-4 md:p-6 mb-6 border border-slate-700/50"><!-- Pollutant Selector -->
     <div class="mb-6"><label class="text-slate-300 text-sm font-medium mb-3 block">é€‰æ‹©æ±¡æŸ“ç‰©</label>
      <div id="pollutant-buttons" class="flex flex-wrap gap-2 md:gap-3"><!-- Buttons generated by JS -->
      </div>
     </div><!-- Year Range -->
     <div><label class="text-slate-300 text-sm font-medium mb-3 block">å¹´ä»½èŒƒå›´</label>
      <div class="flex items-center gap-4"><span id="year-start-label" class="mono text-white text-lg font-medium w-16">2015</span>
       <div class="flex-1 relative">
        <div class="year-range-track h-2 rounded-full relative">
         <div id="year-range-fill" class="absolute h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full"></div>
        </div><input type="range" id="year-start" min="2015" max="2026" value="2015" class="absolute inset-0 w-full h-2 opacity-0 cursor-pointer"> <input type="range" id="year-end" min="2015" max="2026" value="2026" class="absolute inset-0 w-full h-2 opacity-0 cursor-pointer">
       </div><span id="year-end-label" class="mono text-white text-lg font-medium w-16 text-right">2026</span>
      </div>
      <div id="year-pills" class="flex flex-wrap gap-2 mt-3"><!-- Year pills generated by JS -->
      </div>
     </div>
    </div><!-- Visualization Area -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6"><!-- Radial Chart -->
     <div class="lg:col-span-3 bg-slate-800/30 rounded-2xl p-4 md:p-6 border border-slate-700/50 relative">
      <div id="chart-container" class="relative w-full" style="padding-bottom: 100%; max-height: 700px;">
       <svg id="radial-chart" class="absolute inset-0 w-full h-full"></svg><!-- Tooltip -->
       <div id="tooltip" class="tooltip absolute hidden bg-slate-900/95 border border-slate-600 rounded-xl p-4 shadow-2xl z-50 min-w-[200px]">
        <div class="text-slate-400 text-xs mb-1" id="tooltip-date"></div>
        <div class="text-white font-semibold text-lg mb-2" id="tooltip-value"></div>
        <div class="flex items-center gap-2">
         <div id="tooltip-level-dot" class="w-3 h-3 rounded-full"></div><span id="tooltip-level" class="text-sm"></span>
        </div>
       </div>
      </div><!-- Legend -->
      <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
       <div class="flex items-center gap-3">
        <div class="legend-gradient w-32 md:w-48 h-3 rounded-full"></div>
        <div class="flex justify-between text-xs text-slate-400 w-32 md:w-48 -ml-32 md:-ml-48"><span>ä¼˜</span> <span>è‰¯</span> <span>è½»åº¦</span> <span>ä¸­åº¦</span> <span>é‡åº¦</span> <span>ä¸¥é‡</span>
        </div>
       </div>
       <div id="current-pollutant-info" class="text-slate-400 text-sm"></div>
      </div>
     </div><!-- Stats Panel -->
     <div class="lg:col-span-1 space-y-4">
      <div class="stat-card rounded-xl p-4">
       <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
        å½“å‰é€‰æ‹©
       </div>
       <div id="stat-pollutant" class="text-2xl font-bold text-white">
        PM2.5
       </div>
       <div id="stat-unit" class="text-slate-500 text-sm">
        Î¼g/mÂ³
       </div>
      </div>
      <div class="stat-card rounded-xl p-4">
       <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
        å¹´å‡å€¼è¶‹åŠ¿
       </div>
       <div id="stat-trend" class="text-xl font-bold text-emerald-400 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg> -32%
       </div>
       <div class="text-slate-500 text-sm">
        ç›¸è¾ƒäº2015å¹´
       </div>
      </div>
      <div class="stat-card rounded-xl p-4">
       <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
        æœ€é«˜æ±¡æŸ“å­£èŠ‚
       </div>
       <div id="stat-season" class="text-xl font-bold text-amber-400">
        å†¬å­£
       </div>
       <div id="stat-season-detail" class="text-slate-500 text-sm">
        12æœˆ-2æœˆ
       </div>
      </div>
      <div class="stat-card rounded-xl p-4">
       <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
        è¾¾æ ‡å¤©æ•°
       </div>
       <div id="stat-good-days" class="text-xl font-bold text-white"><span class="text-emerald-400">68%</span>
       </div>
       <div class="text-slate-500 text-sm">
        ä¼˜è‰¯å¤©æ•°å æ¯”
       </div>
      </div>
      <div class="stat-card rounded-xl p-4">
       <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
        æ•°æ®è¦†ç›–
       </div>
       <div id="stat-coverage" class="text-lg font-bold text-white">
        4,383 å¤©
       </div>
       <div class="text-slate-500 text-sm">
        å®Œæ•´ç›‘æµ‹è®°å½•
       </div>
      </div>
     </div>
    </div>
   </main><!-- Narrative Mode Overlay -->
   <div id="narrative-overlay" class="fixed inset-0 bg-slate-900/90 z-50 hidden narrative-overlay overflow-auto">
    <div class="min-h-full flex flex-col items-center justify-center p-6">
     <div class="max-w-4xl w-full"><!-- Narrative Header -->
      <div class="text-center mb-8">
       <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">ç©ºæ°”è´¨é‡çš„åå¹´å˜è¿</h2>
       <p class="text-slate-400">ä»æ•°æ®ä¸­è¯»æ‡‚åŸå¸‚çš„å‘¼å¸</p>
      </div><!-- Narrative Steps -->
      <div id="narrative-content" class="bg-slate-800/50 rounded-2xl p-6 md:p-8 border border-slate-700/50"><!-- Content populated by JS -->
      </div><!-- Navigation -->
      <div class="flex items-center justify-between mt-6"><button id="narrative-prev" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"> â† ä¸Šä¸€æ­¥ </button>
       <div id="narrative-progress" class="flex gap-2"><!-- Progress dots -->
       </div><button id="narrative-next" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors"> ä¸‹ä¸€æ­¥ â†’ </button>
      </div><!-- Close Button --> <button id="narrative-close" class="absolute top-6 right-6 text-slate-400 hover:text-white transition-colors">
       <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="max-w-7xl mx-auto mt-8 text-center text-slate-500 text-sm pb-4">
    <p>æ•°æ®æ¥æºï¼šæ¨¡æ‹Ÿæ•°æ® Â· å¯è§†åŒ–è®¾è®¡çµæ„Ÿæ¥è‡ªå¹´è½®ä¸ç”Ÿå‘½å‘¨æœŸ</p>
   </footer>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      chart_title: 'åŸå¸‚ç©ºæ°”è´¨é‡å¹´è½®å›¾',
      city_name: 'åŒ—äº¬',
      primary_color: '#0f172a',
      secondary_color: '#1e293b',
      text_color: '#f8fafc',
      accent_color: '#6366f1',
      highlight_color: '#22c55e'
    };

    // Application state
    let config = { ...defaultConfig };
    let currentPollutant = 'PM2.5';
    let yearStart = 2015;
    let yearEnd = 2026;
    let allData = [];
    let narrativeStep = 0;

    // Pollutant definitions
    const pollutants = {
      'PM2.5': { unit: 'Î¼g/mÂ³', limits: [35, 75, 115, 150, 250, 500], color: '#f97316', description: 'ç»†é¢—ç²’ç‰©ï¼Œç›´å¾„â‰¤2.5å¾®ç±³' },
      'PM10': { unit: 'Î¼g/mÂ³', limits: [50, 150, 250, 350, 420, 600], color: '#eab308', description: 'å¯å¸å…¥é¢—ç²’ç‰©ï¼Œç›´å¾„â‰¤10å¾®ç±³' },
      'O3': { unit: 'Î¼g/mÂ³', limits: [100, 160, 215, 265, 800, 1000], color: '#22c55e', description: 'è‡­æ°§ï¼Œå…‰åŒ–å­¦æ±¡æŸ“æŒ‡æ ‡' },
      'NO2': { unit: 'Î¼g/mÂ³', limits: [40, 80, 180, 280, 565, 940], color: '#ef4444', description: 'äºŒæ°§åŒ–æ°®ï¼Œäº¤é€šæ±¡æŸ“æŒ‡æ ‡' },
      'SO2': { unit: 'Î¼g/mÂ³', limits: [50, 150, 475, 800, 1600, 2620], color: '#a855f7', description: 'äºŒæ°§åŒ–ç¡«ï¼Œå·¥ä¸šæ±¡æŸ“æŒ‡æ ‡' },
      'CO': { unit: 'mg/mÂ³', limits: [2, 4, 14, 24, 36, 60], color: '#64748b', description: 'ä¸€æ°§åŒ–ç¢³ï¼Œç‡ƒçƒ§æ±¡æŸ“æŒ‡æ ‡' }
    };

    // AQI level names and colors
    const aqiLevels = [
      { name: 'ä¼˜', color: '#22c55e' },
      { name: 'è‰¯', color: '#84cc16' },
      { name: 'è½»åº¦æ±¡æŸ“', color: '#eab308' },
      { name: 'ä¸­åº¦æ±¡æŸ“', color: '#f97316' },
      { name: 'é‡åº¦æ±¡æŸ“', color: '#ef4444' },
      { name: 'ä¸¥é‡æ±¡æŸ“', color: '#7c2d12' }
    ];

    // Narrative steps
    const narrativeSteps = [
      {
        title: 'æ¬¢è¿æ¥åˆ°ç©ºæ°”è´¨é‡å¹´è½®å›¾',
        content: `<p class="text-slate-300 text-lg leading-relaxed mb-4">è¿™æ˜¯ä¸€å¼ ç‹¬ç‰¹çš„æ•°æ®å¯è§†åŒ–å›¾è¡¨ï¼Œå®ƒå°†12å¹´çš„ç©ºæ°”è´¨é‡æ•°æ®æµ“ç¼©åœ¨ä¸€å¼ "å¹´è½®"ä¹‹ä¸­ã€‚</p>
        <p class="text-slate-400 leading-relaxed mb-4">å°±åƒæ ‘æœ¨çš„å¹´è½®è®°å½•ç€æ¯ä¸€å¹´çš„ç”Ÿé•¿ï¼Œè¿™å¼ å›¾è®°å½•ç€åŸå¸‚æ¯ä¸€å¤©çš„"å‘¼å¸"çŠ¶å†µã€‚</p>
        <div class="bg-slate-700/50 rounded-lg p-4 mt-6">
          <h4 class="text-white font-medium mb-2">å¦‚ä½•é˜…è¯»è¿™å¼ å›¾ï¼Ÿ</h4>
          <ul class="text-slate-400 space-y-2 text-sm">
            <li>â€¢ <span class="text-white">è§’åº¦</span> ä»£è¡¨ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©ï¼ˆä»1æœˆ1æ—¥åˆ°12æœˆ31æ—¥ï¼‰</li>
            <li>â€¢ <span class="text-white">åœ†ç¯</span> ä»£è¡¨ä¸åŒå¹´ä»½ï¼ˆå†…åœˆæ˜¯2015å¹´ï¼Œå¤–åœˆæ˜¯2026å¹´ï¼‰</li>
            <li>â€¢ <span class="text-white">é¢œè‰²</span> ä»£è¡¨æ±¡æŸ“æµ“åº¦ï¼ˆç»¿è‰²â†’çº¢è‰² = ä¼˜â†’å·®ï¼‰</li>
          </ul>
        </div>`,
        highlight: 'overview'
      },
      {
        title: 'å­£èŠ‚æ€§è§„å¾‹ï¼šå†¬å­£çš„å›°æ‰°',
        content: `<p class="text-slate-300 text-lg leading-relaxed mb-4">ä»”ç»†è§‚å¯Ÿå›¾è¡¨ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªæ˜æ˜¾çš„è§„å¾‹ï¼š<span class="text-amber-400 font-semibold">çº¢è‰²åŒºåŸŸé›†ä¸­åœ¨å›¾è¡¨çš„åº•éƒ¨å’Œå·¦ä¾§</span>ã€‚</p>
        <p class="text-slate-400 leading-relaxed mb-4">è¿™å¯¹åº”çš„æ˜¯11æœˆåˆ°æ¬¡å¹´2æœˆâ€”â€”åŒ—æ–¹ä¾›æš–å­£ã€‚ç‡ƒç…¤å–æš–ã€æ°”è±¡æ¡ä»¶ä¸åˆ©äºæ‰©æ•£ï¼Œå…±åŒé€ æˆäº†å†¬å­£çš„æ±¡æŸ“é«˜å³°ã€‚</p>
        <div class="grid grid-cols-2 gap-4 mt-6">
          <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-4">
            <div class="text-red-400 font-semibold mb-1">å†¬å­£ï¼ˆ12-2æœˆï¼‰</div>
            <div class="text-white text-2xl font-bold">PM2.5 å‡å€¼ 89</div>
            <div class="text-slate-400 text-sm">è¶…æ ‡å¤©æ•°å æ¯”é«˜è¾¾45%</div>
          </div>
          <div class="bg-emerald-900/30 border border-emerald-700/50 rounded-lg p-4">
            <div class="text-emerald-400 font-semibold mb-1">å¤å­£ï¼ˆ6-8æœˆï¼‰</div>
            <div class="text-white text-2xl font-bold">PM2.5 å‡å€¼ 42</div>
            <div class="text-slate-400 text-sm">ä¼˜è‰¯å¤©æ•°å æ¯”è¾¾82%</div>
          </div>
        </div>`,
        highlight: 'winter',
        pollutant: 'PM2.5'
      },
      {
        title: 'åå¹´æ²»ç†ï¼šçœ‹å¾—è§çš„è¿›æ­¥',
        content: `<p class="text-slate-300 text-lg leading-relaxed mb-4">ä»å†…åœˆåˆ°å¤–åœˆï¼Œé¢œè‰²æ•´ä½“åœ¨å˜æµ…å˜ç»¿â€”â€”è¿™æ˜¯<span class="text-emerald-400 font-semibold">åå¹´ç©ºæ°”æ²»ç†æˆæ•ˆ</span>çš„ç›´è§‚ä½“ç°ã€‚</p>
        <p class="text-slate-400 leading-relaxed mb-4">2015å¹´çš„å¹´è½®æ»¡æ˜¯æ©™çº¢ï¼Œè€Œ2024-2026å¹´çš„å¤–åœˆï¼Œç»¿è‰²æ˜æ˜¾å¢å¤šã€‚æ•°æ®æ˜¾ç¤ºï¼š</p>
        <div class="bg-slate-700/50 rounded-lg p-6 mt-6">
          <div class="text-center">
            <div class="text-5xl font-bold text-emerald-400 mb-2">â†“ 42%</div>
            <div class="text-white font-medium">PM2.5 å¹´å‡æµ“åº¦ä¸‹é™</div>
            <div class="text-slate-400 text-sm mt-1">ä»2015å¹´çš„81Î¼g/mÂ³ é™è‡³ 2026å¹´çš„47Î¼g/mÂ³</div>
          </div>
          <div class="grid grid-cols-3 gap-4 mt-6 text-center">
            <div>
              <div class="text-2xl font-bold text-white">+89</div>
              <div class="text-slate-400 text-xs">å¹´å‡ä¼˜è‰¯å¤©æ•°å¢åŠ </div>
            </div>
            <div>
              <div class="text-2xl font-bold text-white">-67%</div>
              <div class="text-slate-400 text-xs">é‡æ±¡æŸ“å¤©æ•°å‡å°‘</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-white">85%</div>
              <div class="text-slate-400 text-xs">2026å¹´è¾¾æ ‡ç‡</div>
            </div>
          </div>
        </div>`,
        highlight: 'trend'
      },
      {
        title: 'æ–°çš„æŒ‘æˆ˜ï¼šè‡­æ°§æ±¡æŸ“',
        content: `<p class="text-slate-300 text-lg leading-relaxed mb-4">åˆ‡æ¢åˆ°è‡­æ°§ï¼ˆO3ï¼‰è§†å›¾ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ª<span class="text-amber-400 font-semibold">ä¸PM2.5å®Œå…¨ç›¸åçš„è§„å¾‹</span>ã€‚</p>
        <p class="text-slate-400 leading-relaxed mb-4">è‡­æ°§æ±¡æŸ“ä¸»è¦å‘ç”Ÿåœ¨å¤å­£â€”â€”é«˜æ¸©å¼ºæ—¥ç…§ä¿ƒè¿›äº†å…‰åŒ–å­¦ååº”ï¼Œä½¿å¾—å¤å­£åè€Œæˆä¸ºè‡­æ°§çš„é«˜å‘æœŸã€‚</p>
        <div class="bg-amber-900/20 border border-amber-700/50 rounded-lg p-4 mt-6">
          <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-amber-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
              <div class="text-amber-400 font-semibold mb-1">å€¼å¾—å…³æ³¨çš„è¶‹åŠ¿</div>
              <p class="text-slate-400 text-sm">ä¸PM2.5ä¸åŒï¼Œè‡­æ°§æµ“åº¦åœ¨è¿‡å»åå¹´å‘ˆä¸Šå‡è¶‹åŠ¿ã€‚è¿™æé†’æˆ‘ä»¬ï¼šç©ºæ°”æ²»ç†æ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦ç»¼åˆæ–½ç­–ã€‚</p>
            </div>
          </div>
        </div>`,
        highlight: 'summer',
        pollutant: 'O3'
      },
      {
        title: 'å¼€å§‹ä½ çš„æ¢ç´¢',
        content: `<p class="text-slate-300 text-lg leading-relaxed mb-4">ç°åœ¨ï¼Œè½®åˆ°ä½ æ¥æ¢ç´¢è¿™å¼ "ç©ºæ°”å¹´è½®å›¾"äº†ï¼</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
          <div class="bg-slate-700/50 rounded-lg p-4">
            <div class="text-indigo-400 font-semibold mb-2">ğŸ” æ¢ç´¢å»ºè®®</div>
            <ul class="text-slate-400 text-sm space-y-2">
              <li>â€¢ åˆ‡æ¢ä¸åŒæ±¡æŸ“ç‰©ï¼Œæ¯”è¾ƒå­£èŠ‚è§„å¾‹</li>
              <li>â€¢ è°ƒæ•´å¹´ä»½èŒƒå›´ï¼Œèšç„¦ç‰¹å®šæ—¶æœŸ</li>
              <li>â€¢ æ‚¬åœæŸ¥çœ‹æ¯ä¸€å¤©çš„ç²¾ç¡®æ•°å€¼</li>
            </ul>
          </div>
          <div class="bg-slate-700/50 rounded-lg p-4">
            <div class="text-emerald-400 font-semibold mb-2">ğŸ’¡ æœ‰è¶£çš„å‘ç°</div>
            <ul class="text-slate-400 text-sm space-y-2">
              <li>â€¢ æ˜¥èŠ‚æœŸé—´çš„ç©ºæ°”å˜åŒ–</li>
              <li>â€¢ é‡å¤§æ´»åŠ¨å‰åçš„å¯¹æ¯”</li>
              <li>â€¢ ä¸åŒæ±¡æŸ“ç‰©çš„æ­¤æ¶ˆå½¼é•¿</li>
            </ul>
          </div>
        </div>
        <p class="text-slate-400 mt-6 text-center">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå…³é—­å™äº‹æ¨¡å¼ï¼Œå¼€å§‹è‡ªç”±æ¢ç´¢ ğŸ‘‡</p>`,
        highlight: 'none'
      }
    ];

    // Generate synthetic pollution data
    function generateData() {
      const data = [];
      const years = [];
      for (let y = 2015; y <= 2026; y++) years.push(y);
      
      years.forEach(year => {
        const daysInYear = (year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0)) ? 366 : 365;
        const yearProgress = (year - 2015) / 11; // 0 to 1 progress through years
        
        for (let day = 1; day <= daysInYear; day++) {
          const dayOfYear = day;
          const monthProgress = dayOfYear / daysInYear;
          
          // Seasonal patterns
          const winterFactor = Math.cos((monthProgress - 0.05) * Math.PI * 2) * 0.5 + 0.5; // Peak in winter
          const summerFactor = Math.cos((monthProgress - 0.55) * Math.PI * 2) * 0.5 + 0.5; // Peak in summer
          
          // Year-over-year improvement for PM (gets better over time)
          const pmImprovement = 1 - yearProgress * 0.4;
          // Year-over-year worsening for O3 (slightly worse over time)
          const o3Worsening = 1 + yearProgress * 0.15;
          
          // Random daily variation
          const randomFactor = () => 0.7 + Math.random() * 0.6;
          
          // Special events (holidays, etc.)
          let holidayFactor = 1;
          if (dayOfYear >= 25 && dayOfYear <= 35) holidayFactor = 0.7; // Spring Festival
          if (dayOfYear >= 275 && dayOfYear <= 285) holidayFactor = 0.75; // National Day
          
          // Calculate values for each pollutant
          const pm25Base = 45 + winterFactor * 80;
          const pm10Base = 70 + winterFactor * 100;
          const o3Base = 60 + summerFactor * 120;
          const no2Base = 35 + winterFactor * 50;
          const so2Base = 15 + winterFactor * 40;
          const coBase = 0.8 + winterFactor * 1.5;
          
          data.push({
            year,
            dayOfYear,
            date: new Date(year, 0, dayOfYear),
            'PM2.5': Math.max(5, Math.round(pm25Base * pmImprovement * randomFactor() * holidayFactor)),
            'PM10': Math.max(10, Math.round(pm10Base * pmImprovement * randomFactor() * holidayFactor)),
            'O3': Math.max(20, Math.round(o3Base * o3Worsening * randomFactor())),
            'NO2': Math.max(10, Math.round(no2Base * pmImprovement * randomFactor() * holidayFactor)),
            'SO2': Math.max(5, Math.round(so2Base * (pmImprovement * 0.7) * randomFactor() * holidayFactor)),
            'CO': Math.max(0.3, Math.round((coBase * pmImprovement * randomFactor() * holidayFactor) * 10) / 10)
          });
        }
      });
      
      return data;
    }

    // Get color for value based on pollutant limits
    function getColor(value, pollutant) {
      const limits = pollutants[pollutant].limits;
      const colors = ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444', '#7c2d12'];
      
      for (let i = 0; i < limits.length; i++) {
        if (value <= limits[i]) {
          if (i === 0) return colors[0];
          // Interpolate between colors
          const prevLimit = i === 0 ? 0 : limits[i - 1];
          const ratio = (value - prevLimit) / (limits[i] - prevLimit);
          return interpolateColor(colors[i - 1], colors[i], ratio);
        }
      }
      return colors[colors.length - 1];
    }

    // Interpolate between two hex colors
    function interpolateColor(color1, color2, ratio) {
      const hex = (c) => parseInt(c.slice(1), 16);
      const r = (c) => (c >> 16) & 255;
      const g = (c) => (c >> 8) & 255;
      const b = (c) => c & 255;
      
      const c1 = hex(color1);
      const c2 = hex(color2);
      
      const red = Math.round(r(c1) + (r(c2) - r(c1)) * ratio);
      const green = Math.round(g(c1) + (g(c2) - g(c1)) * ratio);
      const blue = Math.round(b(c1) + (b(c2) - b(c1)) * ratio);
      
      return `rgb(${red}, ${green}, ${blue})`;
    }

    // Get AQI level
    function getAQILevel(value, pollutant) {
      const limits = pollutants[pollutant].limits;
      for (let i = 0; i < limits.length; i++) {
        if (value <= limits[i]) return aqiLevels[i];
      }
      return aqiLevels[aqiLevels.length - 1];
    }

    // Format date
    function formatDate(date) {
      const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
      return `${date.getFullYear()}å¹´${months[date.getMonth()]}${date.getDate()}æ—¥`;
    }

    // Render pollutant buttons
    function renderPollutantButtons() {
      const container = document.getElementById('pollutant-buttons');
      container.innerHTML = '';
      
      Object.keys(pollutants).forEach(p => {
        const btn = document.createElement('button');
        btn.className = `pollutant-btn px-4 py-2 rounded-lg font-medium text-sm transition-all ${
          currentPollutant === p 
            ? 'active bg-gradient-to-r from-indigo-600 to-purple-600 text-white' 
            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
        }`;
        btn.style.setProperty('--glow-color', pollutants[p].color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(','));
        btn.textContent = p;
        btn.onclick = () => {
          currentPollutant = p;
          renderPollutantButtons();
          renderRadialChart();
          updateStats();
        };
        container.appendChild(btn);
      });
      
      // Update info
      document.getElementById('current-pollutant-info').textContent = pollutants[currentPollutant].description;
    }

    // Render year pills
    function renderYearPills() {
      const container = document.getElementById('year-pills');
      container.innerHTML = '';
      
      for (let y = 2015; y <= 2026; y++) {
        const pill = document.createElement('button');
        const isActive = y >= yearStart && y <= yearEnd;
        pill.className = `px-3 py-1 rounded-full text-xs font-medium transition-all ${
          isActive 
            ? 'bg-indigo-600/30 text-indigo-300 border border-indigo-500/50' 
            : 'bg-slate-700/50 text-slate-500 border border-slate-600/30'
        }`;
        pill.textContent = y;
        pill.onclick = () => {
          if (y < yearEnd) {
            yearStart = y;
          } else {
            yearEnd = y;
          }
          updateYearRange();
          renderYearPills();
          renderRadialChart();
          updateStats();
        };
        container.appendChild(pill);
      }
    }

    // Update year range UI
    function updateYearRange() {
      document.getElementById('year-start-label').textContent = yearStart;
      document.getElementById('year-end-label').textContent = yearEnd;
      
      const fillStart = ((yearStart - 2015) / 11) * 100;
      const fillEnd = ((yearEnd - 2015) / 11) * 100;
      document.getElementById('year-range-fill').style.left = `${fillStart}%`;
      document.getElementById('year-range-fill').style.width = `${fillEnd - fillStart}%`;
    }

    // Render radial chart
    function renderRadialChart() {
      const svg = document.getElementById('radial-chart');
      const container = document.getElementById('chart-container');
      const rect = container.getBoundingClientRect();
      const size = Math.min(rect.width, rect.height);
      const cx = size / 2;
      const cy = size / 2;
      
      // Filter data by year range
      const filteredData = allData.filter(d => d.year >= yearStart && d.year <= yearEnd);
      const years = [...new Set(filteredData.map(d => d.year))].sort();
      const numYears = years.length;
      
      // Calculate radii
      const innerRadius = size * 0.12;
      const outerRadius = size * 0.45;
      const ringWidth = (outerRadius - innerRadius) / numYears;
      
      svg.innerHTML = '';
      svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
      
      // Background circle
      const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      bgCircle.setAttribute('cx', cx);
      bgCircle.setAttribute('cy', cy);
      bgCircle.setAttribute('r', outerRadius + 10);
      bgCircle.setAttribute('fill', 'rgba(15, 23, 42, 0.5)');
      svg.appendChild(bgCircle);
      
      // Month labels and guides
      const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
      const monthDays = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
      
      months.forEach((month, i) => {
        const dayOfYear = monthDays[i] + 15; // Middle of month
        const angle = (dayOfYear / 365) * Math.PI * 2 - Math.PI / 2;
        const labelRadius = outerRadius + 25;
        const x = cx + Math.cos(angle) * labelRadius;
        const y = cy + Math.sin(angle) * labelRadius;
        
        // Guide line
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', cx + Math.cos(angle) * innerRadius);
        line.setAttribute('y1', cy + Math.sin(angle) * innerRadius);
        line.setAttribute('x2', cx + Math.cos(angle) * (outerRadius + 5));
        line.setAttribute('y2', cy + Math.sin(angle) * (outerRadius + 5));
        line.setAttribute('stroke', 'rgba(71, 85, 105, 0.3)');
        line.setAttribute('stroke-width', '1');
        svg.appendChild(line);
        
        // Label
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', y);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', '#94a3b8');
        text.setAttribute('font-size', '11');
        text.setAttribute('class', 'month-label');
        text.textContent = month;
        svg.appendChild(text);
      });
      
      // Year labels
      years.forEach((year, i) => {
        const radius = innerRadius + ringWidth * i + ringWidth / 2;
        const angle = -Math.PI / 2 - 0.15;
        const x = cx + Math.cos(angle) * radius;
        const y = cy + Math.sin(angle) * radius;
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', y);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', 'rgba(148, 163, 184, 0.6)');
        text.setAttribute('font-size', '9');
        text.setAttribute('font-family', 'JetBrains Mono, monospace');
        text.textContent = year.toString().slice(2);
        svg.appendChild(text);
      });
      
      // Data segments
      const tooltip = document.getElementById('tooltip');
      
      filteredData.forEach(d => {
        const yearIndex = years.indexOf(d.year);
        const innerR = innerRadius + ringWidth * yearIndex + 1;
        const outerR = innerRadius + ringWidth * (yearIndex + 1) - 1;
        
        const startAngle = ((d.dayOfYear - 1) / 365) * Math.PI * 2 - Math.PI / 2;
        const endAngle = (d.dayOfYear / 365) * Math.PI * 2 - Math.PI / 2;
        
        const value = d[currentPollutant];
        const color = getColor(value, currentPollutant);
        
        const x1Inner = cx + Math.cos(startAngle) * innerR;
        const y1Inner = cy + Math.sin(startAngle) * innerR;
        const x2Inner = cx + Math.cos(endAngle) * innerR;
        const y2Inner = cy + Math.sin(endAngle) * innerR;
        const x1Outer = cx + Math.cos(startAngle) * outerR;
        const y1Outer = cy + Math.sin(startAngle) * outerR;
        const x2Outer = cx + Math.cos(endAngle) * outerR;
        const y2Outer = cy + Math.sin(endAngle) * outerR;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d_attr = `M ${x1Inner} ${y1Inner} 
                        A ${innerR} ${innerR} 0 0 1 ${x2Inner} ${y2Inner} 
                        L ${x2Outer} ${y2Outer} 
                        A ${outerR} ${outerR} 0 0 0 ${x1Outer} ${y1Outer} 
                        Z`;
        
        path.setAttribute('d', d_attr);
        path.setAttribute('fill', color);
        path.setAttribute('class', 'radial-segment');
        path.setAttribute('data-year', d.year);
        path.setAttribute('data-day', d.dayOfYear);
        
        // Hover events
        path.addEventListener('mouseenter', (e) => {
          const level = getAQILevel(value, currentPollutant);
          document.getElementById('tooltip-date').textContent = formatDate(d.date);
          document.getElementById('tooltip-value').textContent = `${currentPollutant}: ${value} ${pollutants[currentPollutant].unit}`;
          document.getElementById('tooltip-level').textContent = level.name;
          document.getElementById('tooltip-level').style.color = level.color;
          document.getElementById('tooltip-level-dot').style.backgroundColor = level.color;
          
          tooltip.classList.remove('hidden');
          
          const tooltipRect = tooltip.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          let left = e.clientX - containerRect.left + 15;
          let top = e.clientY - containerRect.top + 15;
          
          if (left + tooltipRect.width > containerRect.width) {
            left = e.clientX - containerRect.left - tooltipRect.width - 15;
          }
          if (top + tooltipRect.height > containerRect.height) {
            top = e.clientY - containerRect.top - tooltipRect.height - 15;
          }
          
          tooltip.style.left = `${left}px`;
          tooltip.style.top = `${top}px`;
        });
        
        path.addEventListener('mouseleave', () => {
          tooltip.classList.add('hidden');
        });
        
        svg.appendChild(path);
      });
      
      // Center decoration
      const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      centerCircle.setAttribute('cx', cx);
      centerCircle.setAttribute('cy', cy);
      centerCircle.setAttribute('r', innerRadius - 5);
      centerCircle.setAttribute('fill', 'url(#centerGradient)');
      
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
      gradient.setAttribute('id', 'centerGradient');
      
      const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      stop1.setAttribute('offset', '0%');
      stop1.setAttribute('stop-color', '#1e293b');
      
      const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      stop2.setAttribute('offset', '100%');
      stop2.setAttribute('stop-color', '#0f172a');
      
      gradient.appendChild(stop1);
      gradient.appendChild(stop2);
      defs.appendChild(gradient);
      svg.appendChild(defs);
      svg.appendChild(centerCircle);
      
      // Center text
      const centerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      centerText.setAttribute('x', cx);
      centerText.setAttribute('y', cy);
      centerText.setAttribute('text-anchor', 'middle');
      centerText.setAttribute('dominant-baseline', 'middle');
      centerText.setAttribute('fill', '#e2e8f0');
      centerText.setAttribute('font-size', '14');
      centerText.setAttribute('font-weight', '600');
      centerText.textContent = currentPollutant;
      svg.appendChild(centerText);
    }

    // Update statistics
    function updateStats() {
      const filteredData = allData.filter(d => d.year >= yearStart && d.year <= yearEnd);
      
      // Current pollutant
      document.getElementById('stat-pollutant').textContent = currentPollutant;
      document.getElementById('stat-unit').textContent = pollutants[currentPollutant].unit;
      
      // Calculate trend
      const firstYearData = allData.filter(d => d.year === yearStart);
      const lastYearData = allData.filter(d => d.year === yearEnd);
      const firstYearAvg = firstYearData.reduce((sum, d) => sum + d[currentPollutant], 0) / firstYearData.length;
      const lastYearAvg = lastYearData.reduce((sum, d) => sum + d[currentPollutant], 0) / lastYearData.length;
      const trendPercent = Math.round(((lastYearAvg - firstYearAvg) / firstYearAvg) * 100);
      
      const trendEl = document.getElementById('stat-trend');
      if (trendPercent <= 0) {
        trendEl.className = 'text-xl font-bold text-emerald-400 flex items-center gap-2';
        trendEl.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
          </svg>
          ${trendPercent}%
        `;
      } else {
        trendEl.className = 'text-xl font-bold text-red-400 flex items-center gap-2';
        trendEl.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
          </svg>
          +${trendPercent}%
        `;
      }
      
      // Peak season
      const winterData = filteredData.filter(d => d.dayOfYear <= 59 || d.dayOfYear >= 335);
      const summerData = filteredData.filter(d => d.dayOfYear >= 152 && d.dayOfYear <= 244);
      const winterAvg = winterData.reduce((sum, d) => sum + d[currentPollutant], 0) / winterData.length;
      const summerAvg = summerData.reduce((sum, d) => sum + d[currentPollutant], 0) / summerData.length;
      
      const seasonEl = document.getElementById('stat-season');
      const seasonDetailEl = document.getElementById('stat-season-detail');
      if (winterAvg > summerAvg) {
        seasonEl.textContent = 'å†¬å­£';
        seasonEl.className = 'text-xl font-bold text-amber-400';
        seasonDetailEl.textContent = '12æœˆ-2æœˆ';
      } else {
        seasonEl.textContent = 'å¤å­£';
        seasonEl.className = 'text-xl font-bold text-orange-400';
        seasonDetailEl.textContent = '6æœˆ-8æœˆ';
      }
      
      // Good days percentage
      const limits = pollutants[currentPollutant].limits;
      const goodDays = filteredData.filter(d => d[currentPollutant] <= limits[1]).length;
      const goodPercent = Math.round((goodDays / filteredData.length) * 100);
      document.getElementById('stat-good-days').innerHTML = `<span class="${goodPercent >= 70 ? 'text-emerald-400' : 'text-amber-400'}">${goodPercent}%</span>`;
      
      // Data coverage
      document.getElementById('stat-coverage').textContent = `${filteredData.length.toLocaleString()} å¤©`;
    }

    // Narrative mode
    function renderNarrativeStep() {
      const step = narrativeSteps[narrativeStep];
      const content = document.getElementById('narrative-content');
      
      content.innerHTML = `
        <h3 class="text-2xl font-bold text-white mb-4">${step.title}</h3>
        ${step.content}
      `;
      
      // Update pollutant if specified
      if (step.pollutant && step.pollutant !== currentPollutant) {
        currentPollutant = step.pollutant;
        renderPollutantButtons();
        renderRadialChart();
        updateStats();
      }
      
      // Update navigation buttons
      document.getElementById('narrative-prev').disabled = narrativeStep === 0;
      const nextBtn = document.getElementById('narrative-next');
      if (narrativeStep === narrativeSteps.length - 1) {
        nextBtn.textContent = 'å¼€å§‹æ¢ç´¢ â†’';
      } else {
        nextBtn.textContent = 'ä¸‹ä¸€æ­¥ â†’';
      }
      
      // Update progress dots
      const progress = document.getElementById('narrative-progress');
      progress.innerHTML = narrativeSteps.map((_, i) => `
        <div class="w-2 h-2 rounded-full transition-all ${i === narrativeStep ? 'bg-indigo-500 w-6' : 'bg-slate-600'}"></div>
      `).join('');
    }

    function showNarrative() {
      narrativeStep = 0;
      document.getElementById('narrative-overlay').classList.remove('hidden');
      renderNarrativeStep();
    }

    function hideNarrative() {
      document.getElementById('narrative-overlay').classList.add('hidden');
    }

    // Apply config to UI
    function applyConfig() {
      document.getElementById('main-title').textContent = config.chart_title || defaultConfig.chart_title;
      document.getElementById('city-display').textContent = config.city_name || defaultConfig.city_name;
      
      document.body.style.background = `linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 50%, ${config.primary_color} 100%)`;
    }

    // Initialize
    async function init() {
      // Generate data
      allData = generateData();
      
      // Setup year range sliders
      const yearStartSlider = document.getElementById('year-start');
      const yearEndSlider = document.getElementById('year-end');
      
      yearStartSlider.addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        if (val < yearEnd) {
          yearStart = val;
          updateYearRange();
          renderYearPills();
          renderRadialChart();
          updateStats();
        }
      });
      
      yearEndSlider.addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        if (val > yearStart) {
          yearEnd = val;
          updateYearRange();
          renderYearPills();
          renderRadialChart();
          updateStats();
        }
      });
      
      // Narrative mode buttons
      document.getElementById('narrative-btn').addEventListener('click', showNarrative);
      document.getElementById('narrative-close').addEventListener('click', hideNarrative);
      document.getElementById('narrative-prev').addEventListener('click', () => {
        if (narrativeStep > 0) {
          narrativeStep--;
          renderNarrativeStep();
        }
      });
      document.getElementById('narrative-next').addEventListener('click', () => {
        if (narrativeStep < narrativeSteps.length - 1) {
          narrativeStep++;
          renderNarrativeStep();
        } else {
          hideNarrative();
        }
      });
      
      // Initial render
      renderPollutantButtons();
      renderYearPills();
      updateYearRange();
      renderRadialChart();
      updateStats();
      applyConfig();
      
      // Handle resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(renderRadialChart, 150);
      });
      
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.primary_color || defaultConfig.primary_color,
                set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
              },
              {
                get: () => cfg.secondary_color || defaultConfig.secondary_color,
                set: (v) => { cfg.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
              },
              {
                get: () => cfg.accent_color || defaultConfig.accent_color,
                set: (v) => { cfg.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); }
              },
              {
                get: () => cfg.highlight_color || defaultConfig.highlight_color,
                set: (v) => { cfg.highlight_color = v; window.elementSdk.setConfig({ highlight_color: v }); }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['chart_title', cfg.chart_title || defaultConfig.chart_title],
            ['city_name', cfg.city_name || defaultConfig.city_name]
          ])
        });
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cdab74a7172e7bc',t:'MTc3MTA1MjcxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
